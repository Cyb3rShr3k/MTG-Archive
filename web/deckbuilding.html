<!DOCTYPE HTML>
<html>
<head>
	<title>MTG Archive - Deck Building</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<link rel="stylesheet" href="HTML5up/assets/css/main.css" />
	<script src="api.js"></script>
	<script src="shared-nav.js"></script>
	<style>
		.deck-card {
			cursor: pointer;
			transition: all 0.3s ease;
			border: 2px solid transparent;
			padding: 1.5em;
			border-radius: 4px;
			background: linear-gradient(135deg, rgba(245, 106, 106, 0.05) 0%, rgba(76, 132, 255, 0.05) 100%);
		}
		.deck-card:hover {
			transform: translateY(-3px);
			border-color: #f56a6a;
			box-shadow: 0 8px 20px rgba(0,0,0,0.15);
		}
		.deck-card.selected {
			border-color: #4c84ff;
			background: rgba(76, 132, 255, 0.15);
		}
		.deck-card h3 {
			margin: 0 0 0.5em 0;
			color: #f56a6a;
		}
		.deck-card p {
			margin: 0.25em 0;
			color: #999;
			font-size: 0.9em;
		}
		.deck-card .deck-stats {
			display: flex;
			gap: 1em;
			margin-top: 1em;
			padding-top: 1em;
			border-top: 1px solid rgba(255,255,255,0.1);
		}
		.deck-card .deck-stats span {
			font-size: 0.8em;
			color: #666;
		}
		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			overflow: auto;
			background-color: rgba(0,0,0,0.6);
		}
		.modal-content {
			background-color: #242943;
			margin: 3% auto;
			padding: 2em;
			border: 1px solid #888;
			border-radius: 4px;
			width: 90%;
			max-width: 1200px;
			max-height: 85vh;
			overflow-y: auto;
			color: #fff;
		}
		.modal-close {
			color: #aaa;
			float: right;
			font-size: 28px;
			font-weight: bold;
			cursor: pointer;
		}
		.modal-close:hover {
			color: #f56a6a;
		}
		.card-search-result {
			padding: 0.5em;
			border: 1px solid #333;
			border-radius: 4px;
			margin-bottom: 0.5em;
			cursor: pointer;
			display: flex;
			justify-content: space-between;
			align-items: center;
			transition: all 0.2s ease;
		}
		.card-search-result:hover {
			background: rgba(245, 106, 106, 0.1);
			border-color: #f56a6a;
		}
		.deck-table {
			width: 100%;
			border-collapse: collapse;
		}
		.deck-table th {
			background: #242943;
			color: #fff;
			padding: 0.75em;
			text-align: left;
			border-bottom: 2px solid #f56a6a;
		}
		.deck-table td {
			padding: 0.5em 0.75em;
			border-bottom: 1px solid #ddd;
		}
		.deck-table tr:nth-child(even) {
			background: #f9f9f9;
		}
		.deck-table tr:hover {
			background: #f0f0f0;
		}
		.mana-curve {
			display: flex;
			align-items: flex-end;
			gap: 0.25em;
			height: 60px;
		}
		.mana-curve-bar {
			flex: 1;
			background: linear-gradient(to top, #f56a6a, #4c84ff);
			border-radius: 2px 2px 0 0;
			position: relative;
			min-width: 20px;
		}
		.mana-curve-bar span {
			position: absolute;
			top: -20px;
			left: 50%;
			transform: translateX(-50%);
			font-size: 0.7em;
			color: #666;
		}
		.preview-card {
			display: none;
			position: fixed;
			pointer-events: none;
			z-index: 2000;
			background: white;
			border: 2px solid #242943;
			border-radius: 8px;
			padding: 4px;
			box-shadow: 0 8px 32px rgba(0,0,0,0.3);
		}
		.preview-card img {
			max-width: 260px;
			height: auto;
			border-radius: 4px;
		}
	</style>
</head>
<body class="is-preload">

	<!-- Wrapper -->
	<div id="wrapper">

		<!-- Main -->
		<div id="main">
			<div class="inner">

				<!-- Header -->
				<script>document.write(sharedNav.header('Deck Building'));</script>

				<!-- Deck Actions -->
				<section>
					<ul class="actions">
						<li><button class="button primary icon solid fa-plus" onclick="createNewDeck()">Create New Deck</button></li>
						<li><button class="button icon solid fa-download" onclick="openPreconModal()">Import Precon</button></li>
						<li><button class="button icon solid fa-edit" id="editDeckBtn" onclick="editSelectedDeck()" disabled>Edit Deck</button></li>
						<li><button class="button icon solid fa-trash" id="deleteDeckBtn" onclick="deleteSelectedDeck()" disabled>Delete Deck</button></li>
					</ul>
				</section>

				<!-- Deck List -->
				<section>
					<header class="major">
						<h2>Your Decks</h2>
					</header>
					<div id="deckList" class="row gtr-200"></div>
				</section>

			</div>
		</div>

		<!-- Sidebar -->
		<script>document.write(sharedNav.sidebar);</script>

	</div>

	<!-- Create Deck Modal -->
	<div id="createDeckModal" class="modal">
		<div class="modal-content">
			<span class="modal-close" onclick="closeModal('createDeckModal')">&times;</span>
			<h2>Create New Deck</h2>
			<form id="createDeckForm">
				<div class="row gtr-uniform">
					<div class="col-6 col-12-xsmall">
						<label for="deckName">Deck Name</label>
						<input type="text" id="deckName" name="deckName" required />
					</div>
					<div class="col-6 col-12-xsmall">
						<label for="deckType">Deck Type</label>
						<select id="deckType" name="deckType">
							<option value="Standard">Standard</option>
							<option value="Commander">Commander</option>
							<option value="Modern">Modern</option>
							<option value="Legacy">Legacy</option>
							<option value="Vintage">Vintage</option>
							<option value="Pauper">Pauper</option>
							<option value="Pioneer">Pioneer</option>
						</select>
					</div>
					<div class="col-12" id="commanderField" style="display:none;">
						<label for="commanderName">Commander</label>
						<input type="text" id="commanderName" name="commanderName" placeholder="Search for commander..." />
						<div id="commanderResults" style="margin-top:0.5em;"></div>
					</div>
					<div class="col-12">
						<ul class="actions">
							<li><button type="submit" class="button primary">Create</button></li>
							<li><button type="button" class="button" onclick="closeModal('createDeckModal')">Cancel</button></li>
						</ul>
					</div>
				</div>
			</form>
		</div>
	</div>

	<!-- Edit Deck Modal -->
	<div id="editDeckModal" class="modal">
		<div class="modal-content">
			<span class="modal-close" onclick="closeModal('editDeckModal')">&times;</span>
			<h2 id="editDeckTitle">Edit Deck</h2>
			
			<div class="row gtr-uniform">
				<div class="col-6 col-12-small">
					<h3>Search Cards</h3>
					<input type="text" id="cardSearch" placeholder="Search by name..." />
					<div id="searchResults" style="max-height:400px; overflow-y:auto; margin-top:1em;"></div>
				</div>
				<div class="col-6 col-12-small">
					<h3>Current Deck (<span id="deckCardCount">0</span> cards)</h3>
					<div id="currentDeckCards" style="max-height:400px; overflow-y:auto;"></div>
					
					<h4 style="margin-top:2em;">Mana Curve</h4>
					<div id="manaCurve" class="mana-curve"></div>
				</div>
			</div>
			
			<ul class="actions" style="margin-top:2em;">
				<li><button class="button primary" onclick="saveDeckChanges()">Save Changes</button></li>
				<li><button class="button" onclick="closeModal('editDeckModal')">Cancel</button></li>
			</ul>
		</div>
	</div>

	<!-- Precon Import Modal -->
	<div id="preconModal" class="modal">
		<div class="modal-content">
			<span class="modal-close" onclick="closeModal('preconModal')">&times;</span>
			<h2>Import Preconstructed Deck</h2>
			
			<div class="row gtr-uniform">
				<div class="col-12">
					<input type="text" id="preconSearch" placeholder="Search precons by name or set..." />
				</div>
				<div class="col-12">
					<div id="preconResults" style="max-height:500px; overflow-y:auto; margin-top:1em;"></div>
				</div>
			</div>
		</div>
	</div>

	<!-- Card Preview -->
	<div id="cardPreview" class="preview-card">
		<img id="cardPreviewImg" src="" alt="Card Preview" />
	</div>

	<!-- Scripts -->
	<script src="HTML5up/assets/js/jquery.min.js"></script>
	<script src="HTML5up/assets/js/browser.min.js"></script>
	<script src="HTML5up/assets/js/breakpoints.min.js"></script>
	<script src="HTML5up/assets/js/util.js"></script>
	<script src="HTML5up/assets/js/main.js"></script>

	<script>
		let allDecks = [];
		let selectedDeck = null;
		let editingDeck = null;
		let currentDeckCards = [];
		let searchTimeout = null;

		// Load all decks
		async function loadDecks() {
			try {
				const decks = await window.pywebview.api.list_decks();
				allDecks = decks || [];
				renderDecks();
			} catch (error) {
				console.error('Failed to load decks:', error);
			}
		}

		function renderDecks() {
			const container = document.getElementById('deckList');
			
			if (allDecks.length === 0) {
				container.innerHTML = '<div class="col-12"><p>No decks yet. Create your first deck!</p></div>';
				return;
			}

			const html = allDecks.map(deck => `
				<div class="col-4 col-12-medium">
					<div class="deck-card" onclick="selectDeck('${deck.name}')">
						<h3>${deck.name || 'Unnamed Deck'}</h3>
						<p><strong>Type:</strong> ${deck.deck_type || 'Standard'}</p>
						${deck.commander ? `<p><strong>Commander:</strong> ${deck.commander}</p>` : ''}
						${deck.colors ? `<p><strong>Colors:</strong> ${deck.colors}</p>` : ''}
						<div class="deck-stats">
							<span><strong>${deck.card_count || 0}</strong> cards</span>
							${deck.avg_cmc ? `<span><strong>Avg CMC:</strong> ${deck.avg_cmc.toFixed(1)}</span>` : ''}
						</div>
					</div>
				</div>
			`).join('');

			container.innerHTML = html;
		}

		function selectDeck(deckName) {
			// Remove previous selection
			document.querySelectorAll('.deck-card').forEach(el => el.classList.remove('selected'));
			
			// Find and select new deck
			selectedDeck = allDecks.find(d => d.name === deckName);
			
			if (selectedDeck) {
				event.currentTarget.classList.add('selected');
				document.getElementById('editDeckBtn').disabled = false;
				document.getElementById('deleteDeckBtn').disabled = false;
			}
		}

		// Create new deck
		function createNewDeck() {
			document.getElementById('createDeckModal').style.display = 'block';
		}

		document.getElementById('deckType').addEventListener('change', function() {
			const commanderField = document.getElementById('commanderField');
			commanderField.style.display = this.value === 'Commander' ? 'block' : 'none';
		});

		document.getElementById('commanderName').addEventListener('input', async function() {
			const query = this.value.trim();
			const resultsDiv = document.getElementById('commanderResults');
			
			if (query.length < 3) {
				resultsDiv.innerHTML = '';
				return;
			}

			clearTimeout(searchTimeout);
			searchTimeout = setTimeout(async () => {
				try {
					const results = await window.pywebview.api.search_scryfall(query, 10);
					const commanders = results.filter(card => 
						card.type && (card.type.includes('Legendary') && card.type.includes('Creature'))
					);

					if (commanders.length > 0) {
						resultsDiv.innerHTML = commanders.map(card => `
							<div class="card-search-result" onclick="selectCommander('${card.name}')">
								${card.name} (${card.set || 'Unknown'})
							</div>
						`).join('');
					} else {
						resultsDiv.innerHTML = '<p>No legendary creatures found.</p>';
					}
				} catch (error) {
					console.error('Commander search error:', error);
				}
			}, 300);
		});

		function selectCommander(name) {
			document.getElementById('commanderName').value = name;
			document.getElementById('commanderResults').innerHTML = '';
		}

		document.getElementById('createDeckForm').addEventListener('submit', async function(e) {
			e.preventDefault();
			
			const deckName = document.getElementById('deckName').value;
			const deckType = document.getElementById('deckType').value;
			const commanderName = deckType === 'Commander' ? document.getElementById('commanderName').value : null;

			try {
				await window.pywebview.api.create_deck(deckName, deckType, commanderName);
				alert('Deck created successfully!');
				closeModal('createDeckModal');
				document.getElementById('createDeckForm').reset();
				await loadDecks();
			} catch (error) {
				console.error('Deck creation error:', error);
				alert('Failed to create deck.');
			}
		});

		// Edit deck
		async function editSelectedDeck() {
			if (!selectedDeck) return;
			
			editingDeck = selectedDeck;
			document.getElementById('editDeckTitle').textContent = `Edit: ${selectedDeck.name}`;
			document.getElementById('editDeckModal').style.display = 'block';
			
			await loadDeckCards();
		}

		async function loadDeckCards() {
			try {
				const cards = await window.pywebview.api.get_deck_cards(editingDeck.name);
				currentDeckCards = cards || [];
				renderDeckCards();
				updateManaCurve();
			} catch (error) {
				console.error('Failed to load deck cards:', error);
			}
		}

		function renderDeckCards() {
			const container = document.getElementById('currentDeckCards');
			document.getElementById('deckCardCount').textContent = currentDeckCards.length;

			if (currentDeckCards.length === 0) {
				container.innerHTML = '<p>No cards in deck yet.</p>';
				return;
			}

			const html = currentDeckCards.map((card, idx) => `
				<div class="card-search-result">
					<span>${card.name}</span>
					<button class="button small" onclick="removeCardFromDeck(${idx})">Remove</button>
				</div>
			`).join('');

			container.innerHTML = html;
		}

		function removeCardFromDeck(index) {
			currentDeckCards.splice(index, 1);
			renderDeckCards();
			updateManaCurve();
		}

		document.getElementById('cardSearch').addEventListener('input', async function() {
			const query = this.value.trim();
			const resultsDiv = document.getElementById('searchResults');
			
			if (query.length < 3) {
				resultsDiv.innerHTML = '';
				return;
			}

			clearTimeout(searchTimeout);
			searchTimeout = setTimeout(async () => {
				try {
					const results = await window.pywebview.api.search_collection({ query, filters: {} });
					
					if (results && results.length > 0) {
						resultsDiv.innerHTML = results.map(card => `
							<div class="card-search-result" onclick="addCardToDeck('${card.name}')">
								<span>${card.name} (${card.set || 'N/A'})</span>
								<span class="icon solid fa-plus" style="color:#39c088;"></span>
							</div>
						`).join('');
					} else {
						resultsDiv.innerHTML = '<p>No cards found in collection.</p>';
					}
				} catch (error) {
					console.error('Card search error:', error);
				}
			}, 300);
		});

		async function addCardToDeck(cardName) {
			try {
				const results = await window.pywebview.api.search_collection({ query: cardName, filters: {} });
				const card = results && results[0];
				
				if (card) {
					currentDeckCards.push(card);
					renderDeckCards();
					updateManaCurve();
				}
			} catch (error) {
				console.error('Add card error:', error);
			}
		}

		function updateManaCurve() {
			const curve = {};
			currentDeckCards.forEach(card => {
				const cmc = Math.min(card.cmc || 0, 7);
				curve[cmc] = (curve[cmc] || 0) + 1;
			});

			const maxCount = Math.max(...Object.values(curve), 1);
			const html = [0, 1, 2, 3, 4, 5, 6, 7].map(cmc => {
				const count = curve[cmc] || 0;
				const height = (count / maxCount) * 100;
				return `<div class="mana-curve-bar" style="height:${height}%"><span>${count}</span></div>`;
			}).join('');

			document.getElementById('manaCurve').innerHTML = html;
		}

		async function saveDeckChanges() {
			try {
				await window.pywebview.api.update_deck(editingDeck.name, currentDeckCards);
				alert('Deck saved successfully!');
				closeModal('editDeckModal');
				await loadDecks();
			} catch (error) {
				console.error('Save deck error:', error);
				alert('Failed to save deck.');
			}
		}

		// Delete deck
		async function deleteSelectedDeck() {
			if (!selectedDeck) return;
			
			if (confirm(`Are you sure you want to delete "${selectedDeck.name}"?`)) {
				try {
					await window.pywebview.api.delete_deck(selectedDeck.name);
					alert('Deck deleted successfully!');
					selectedDeck = null;
					document.getElementById('editDeckBtn').disabled = true;
					document.getElementById('deleteDeckBtn').disabled = true;
					await loadDecks();
				} catch (error) {
					console.error('Delete deck error:', error);
					alert('Failed to delete deck.');
				}
			}
		}

		// Precon import
		async function openPreconModal() {
			document.getElementById('preconModal').style.display = 'block';
			loadPrecons();
		}

		async function loadPrecons() {
			try {
				const precons = await window.pywebview.api.get_precon_decks();
				renderPrecons(precons || []);
			} catch (error) {
				console.error('Failed to load precons:', error);
			}
		}

		function renderPrecons(precons) {
			const container = document.getElementById('preconResults');
			
			if (precons.length === 0) {
				container.innerHTML = '<p>No preconstructed decks available.</p>';
				return;
			}

			const html = precons.map(precon => `
				<div class="card-search-result" onclick="importPrecon('${precon.name}')">
					<div>
						<strong>${precon.name}</strong><br>
						<small>${precon.set || 'Unknown Set'} â€¢ ${precon.card_count || 0} cards</small>
					</div>
					<button class="button small primary">Import</button>
				</div>
			`).join('');

			container.innerHTML = html;
		}

		document.getElementById('preconSearch').addEventListener('input', async function() {
			const query = this.value.trim().toLowerCase();
			
			try {
				const allPrecons = await window.pywebview.api.get_precon_decks();
				const filtered = allPrecons.filter(p => 
					p.name.toLowerCase().includes(query) || 
					(p.set && p.set.toLowerCase().includes(query))
				);
				renderPrecons(filtered);
			} catch (error) {
				console.error('Precon search error:', error);
			}
		});

		async function importPrecon(preconName) {
			try {
				await window.pywebview.api.import_precon_deck(preconName);
				alert(`Imported "${preconName}" successfully!`);
				closeModal('preconModal');
				await loadDecks();
			} catch (error) {
				console.error('Precon import error:', error);
				alert('Failed to import precon.');
			}
		}

		// Modal management
		function closeModal(modalId) {
			document.getElementById(modalId).style.display = 'none';
		}

		window.onclick = function(event) {
			if (event.target.classList.contains('modal')) {
				event.target.style.display = 'none';
			}
		}

		// Initialize
		window.addEventListener('DOMContentLoaded', loadDecks);
	</script>

</body>
</html>
