<!DOCTYPE HTML>
<html>
<head>
    <title>Login - MTG Archive</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="HTML5up/assets/css/main.css" />
    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Firebase REST API -->
    <script defer src="firebase-rest.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .auth-container {
            background: #242943;
            padding: 3em;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            width: 100%;
            max-width: 500px;
            color: #fff;
        }
        .auth-container h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 0.5em;
        }
        .auth-container p.subtitle {
            text-align: center;
            color: #999;
            margin-bottom: 2em;
        }
        .error {
            background: rgba(245, 106, 106, 0.2);
            border: 1px solid #f56a6a;
            color: #f56a6a;
            padding: 1em;
            border-radius: 4px;
            margin-bottom: 1.5em;
            display: none;
        }
        .auth-links {
            text-align: center;
            margin-top: 1.5em;
            padding-top: 1.5em;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .auth-links a {
            color: #4c84ff;
            text-decoration: none;
        }
        .auth-links a:hover {
            color: #f56a6a;
        }
        .divider {
            text-align: center;
            margin: 1.5em 0;
            color: #999;
            font-size: 0.9em;
        }
        #googleSignInButton {
            margin: 1.5em 0;
            display: flex;
            justify-content: center;
            width: 100%;
        }
        .skip-link {
            text-align: center;
            margin-top: 1em;
            font-size: 0.85em;
        }
        .skip-link a {
            color: #666;
            text-decoration: none;
        }
        .skip-link a:hover {
            color: #888;
        }
        /* Input field styling */
        .auth-container input[type="text"],
        .auth-container input[type="password"] {
            background-color: #1a1f2e !important;
            border-color: #444 !important;
            color: #fff !important;
        }
        .auth-container input[type="text"]::placeholder,
        .auth-container input[type="password"]::placeholder {
            color: #888 !important;
        }
        .auth-container input[type="text"]:focus,
        .auth-container input[type="password"]:focus {
            background-color: #242943 !important;
            border-color: #4c84ff !important;
            box-shadow: 0 0 0 2px rgba(76, 132, 255, 0.2) !important;
        }
    </style>
</head>
<body class="is-preload">

    <div class="auth-container">
        <h1>MTG Archive</h1>
        <p class="subtitle">Sign in to your collection</p>
        
        <div id="errorMsg" class="error"></div>
        
        <!-- Google Sign-In Button -->
        <div id="googleSignInButton"></div>
        
        <div class="auth-links">
            <p>Don't have an account? <a href="register.html">Register here</a></p>
        </div>
        
        <div class="skip-link">
            <p><a href="index.html">Continue as guest</a></p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="HTML5up/assets/js/jquery.min.js"></script>
    <script src="HTML5up/assets/js/browser.min.js"></script>
    <script src="HTML5up/assets/js/breakpoints.min.js"></script>
    <script src="HTML5up/assets/js/util.js"></script>
    <script src="HTML5up/assets/js/main.js"></script>

    <script>
        // Initialize Google Sign-In
        function initializeGoogleSignIn() {
            if (typeof google !== 'undefined' && google.accounts) {
                google.accounts.id.initialize({
                    client_id: '137025206900-k2iq8lh8hmmj14udc3nvvpasugqqa8cf.apps.googleusercontent.com',
                    callback: handleGoogleSignInResponse
                });
                
                google.accounts.id.renderButton(
                    document.getElementById('googleSignInButton'),
                    { 
                        theme: 'dark',
                        size: 'large',
                        text: 'signin_with'
                    }
                );
                console.log('✅ Google Sign-In initialized');
            } else {
                console.warn('Google Sign-In library not loaded');
            }
        }
        
        function handleGoogleSignInResponse(response) {
            console.log('Google Sign-In response received');
            // Decode JWT to get user info
            const base64Url = response.credential.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(
                atob(base64).split('').map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')
            );
            const payload = JSON.parse(jsonPayload);
            
            console.log('Google user:', payload);
            
            // Use email as username if not provided
            const username = payload.email.split('@')[0];
            const email = payload.email;
            
            // Store Google token
            if (typeof firebaseDB !== 'undefined' && firebaseDB) {
                firebaseDB.idToken = response.credential;
                firebaseDB.currentUser = {
                    uid: payload.sub,
                    email: email,
                    username: username,
                    googleAuth: true
                };
                
                try {
                    localStorage.setItem('firebaseDB_token', response.credential);
                    localStorage.setItem('firebaseDB_user', JSON.stringify(firebaseDB.currentUser));
                } catch (e) {
                    console.warn('Could not save to localStorage:', e);
                }
            }
            
            // Redirect to deckbuilding page
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.style.display = 'none';
            
            const successDiv = document.createElement('div');
            successDiv.style.background = 'rgba(57, 192, 136, 0.2)';
            successDiv.style.border = '1px solid #39c088';
            successDiv.style.color = '#39c088';
            successDiv.style.padding = '1em';
            successDiv.style.borderRadius = '4px';
            successDiv.style.marginBottom = '1.5em';
            successDiv.textContent = 'Sign in successful! Redirecting...';
            
            errorMsg.parentElement.insertBefore(successDiv, errorMsg.nextSibling);
            
            setTimeout(() => {
                window.location.href = 'deckbuilding.html';
            }, 1500);
        }
        
        // Wait for Google Sign-In to load
        function waitForGoogleSignIn() {
            return new Promise((resolve) => {
                let attempts = 0;
                const checkReady = setInterval(() => {
                    attempts++;
                    if (typeof google !== 'undefined' && google.accounts) {
                        clearInterval(checkReady);
                        console.log('✅ Google Sign-In library loaded');
                        initializeGoogleSignIn();  // <-- IMPORTANT: Actually initialize it!
                        resolve();
                    } else if (attempts > 50) {
                        clearInterval(checkReady);
                        console.warn('Google Sign-In library failed to load');
                        resolve();
                    }
                }, 100);
            });
        }

        // Wait for Firebase REST API to load with proper timeout
        function waitForFirebaseRest() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 100; // 10 seconds
                
                const checkReady = setInterval(() => {
                    attempts++;
                    
                    if (typeof firebaseDB !== 'undefined' && firebaseDB && typeof firebaseDB.login === 'function') {
                        clearInterval(checkReady);
                        console.log('✅ Firebase REST API ready');
                        resolve();
                        return;
                    }
                    
                    if (attempts >= maxAttempts) {
                        clearInterval(checkReady);
                        console.warn('⏰ Firebase REST API loading timeout, continuing anyway...');
                        resolve();
                        return;
                    }
                }, 100);
            });
        }

        // Initialize login check
        async function initializeLogin() {
            await waitForGoogleSignIn();
            await waitForFirebaseRest();
            
            if (!firebaseDB || typeof firebaseDB.login !== 'function') {
                console.error('Firebase REST API not loaded properly');
                // Continue anyway - user can still try to login
                return;
            }
            
            // Check if already logged in
            const user = firebaseDB.getCurrentUser();
            if (user) {
                window.location.href = 'index.html';
            }
        }

        // Start initialization
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeLogin);
        } else {
            initializeLogin();
        }
    </script>

</body>
</html>
